<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Pricing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4CAF50;
        }

        .status-indicator.disconnected {
            background: #f44336;
        }

        .zones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .zone-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .zone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zone-id {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .zone-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .zone-type.downtown {
            background: #ffebee;
            color: #c62828;
        }

        .zone-type.urban {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .zone-type.suburban {
            background: #fff3e0;
            color: #ef6c00;
        }

        .zone-type.airport {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .price-display {
            text-align: center;
            margin: 20px 0;
        }

        .surge-multiplier {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.5s ease;
        }

        .surge-multiplier.increase {
            color: #4CAF50;
            animation: blinkGreen 1s ease-in-out;
        }

        .surge-multiplier.decrease {
            color: #f44336;
            animation: blinkRed 1s ease-in-out;
        }

        .surge-multiplier.no-change {
            color: #333;
        }

        .surge-label {
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
        }

        .controls h3 {
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .control-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .control-group button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-group button:hover {
            background: rgba(255,255,255,0.3);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes blinkGreen {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(76, 175, 80, 0.2); }
        }

        @keyframes blinkRed {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(244, 67, 54, 0.2); }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .experiment-status {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .experiment-status .status-item {
            background: rgba(255,255,255,0.15);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        @media (max-width: 768px) {
            .zones-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
            }
            
            .control-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš— Dynamic Pricing Dashboard</h1>
            <p>Real-time surge pricing across 16 zones</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionText">Connecting...</span>
            </div>
            <div class="status-item">
                <span>Last Update: <span id="lastUpdate">Never</span></span>
            </div>
            <div class="status-item">
                <span>Total Updates: <span id="totalUpdates">0</span></span>
            </div>
        </div>

        <div class="controls">
            <h3>Experiment Status</h3>
            <div id="experimentStatus" class="experiment-status">
                <div class="status-item">
                    <span><strong>Mode:</strong> <span id="experimentMode">Loading...</span></span>
                </div>
                <div class="status-item">
                    <span><strong>Seed:</strong> <span id="experimentSeed">-</span></span>
                </div>
                <div class="status-item">
                    <span><strong>Scenario:</strong> <span id="experimentScenario">-</span></span>
                </div>
            </div>
        </div>

        <div class="controls">
            <h3>Display Controls</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showOnlySurge" />
                    Show only zones with surge pricing
                </label>
                <label>
                    <input type="checkbox" id="autoRefresh" checked />
                    Auto-refresh every 2 seconds
                </label>
                <button onclick="reconnectAllZones()">Reconnect</button>
            </div>
        </div>

        <div id="loading" class="loading">
            Loading zone data...
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            Failed to connect to pricing API. Please ensure the system is running.
        </div>

        <div id="zonesContainer" class="zones-grid" style="display: none;">
            <!-- Zone cards will be populated here -->
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8081/api/v1';
        const REFRESH_INTERVAL = 2000; // 2 seconds
        const ZONE_TYPES = {
            1: 'downtown', 2: 'downtown', 3: 'downtown', 4: 'downtown',
            5: 'urban', 6: 'urban', 7: 'urban', 8: 'urban',
            9: 'suburban', 10: 'suburban', 11: 'suburban', 12: 'suburban',
            13: 'airport', 14: 'airport', 15: 'airport', 16: 'airport'
        };

        // State
        let zoneData = {};
        let previousZoneData = {};
        let updateCount = 0;
        let experimentMode = false;
        let sseConnections = new Map(); // Map of zoneId -> EventSource
        let reconnectAttempts = new Map(); // Track reconnection attempts per zone
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_DELAY = 2000; // 2 seconds

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeZones();
            connectSSE();
            setupEventListeners();
            loadExperimentStatus();
        });

        function initializeZones() {
            const container = document.getElementById('zonesContainer');
            container.innerHTML = '';

            for (let zoneId = 1; zoneId <= 16; zoneId++) {
                const zoneCard = createZoneCard(zoneId);
                container.appendChild(zoneCard);
            }
        }

        function createZoneCard(zoneId) {
            const card = document.createElement('div');
            card.className = 'zone-card';
            card.id = `zone-${zoneId}`;
            
            const zoneType = ZONE_TYPES[zoneId];
            
            card.innerHTML = `
                <div class="zone-header">
                    <div class="zone-id">Zone ${zoneId}</div>
                    <div class="zone-type ${zoneType}">${zoneType.toUpperCase()}</div>
                </div>
                <div class="price-display">
                    <div class="surge-multiplier no-change" id="surge-${zoneId}">1.0x</div>
                    <div class="surge-label">Surge Multiplier</div>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="demand-${zoneId}">0</div>
                        <div class="metric-label">Demand</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="supply-${zoneId}">0</div>
                        <div class="metric-label">Supply</div>
                    </div>
                </div>
                <div class="last-updated" id="updated-${zoneId}">Never updated</div>
            `;
            
            return card;
        }

        function setupEventListeners() {
            document.getElementById('showOnlySurge').addEventListener('change', filterZones);
            // Remove auto-refresh toggle since we're using real-time SSE
            document.getElementById('autoRefresh').style.display = 'none';
            document.querySelector('label[for="autoRefresh"]').style.display = 'none';
        }

        function connectSSE() {
            console.log('Connecting to single SSE stream for all zones...');
            
            // Use a single SSE connection for all zones to avoid browser connection limits
            connectAllZonesSSE();
            
            // Do ONE initial fetch to populate data immediately
            refreshAllZones();
        }
        
        function connectAllZonesSSE() {
            console.log('Establishing SSE connection for all zones...');
            const eventSource = new EventSource(`${API_BASE_URL}/zones/all/stream`);
            
            eventSource.addEventListener('connected', function(event) {
                console.log('âœ“ SSE connected for all zones');
                updateConnectionStatus(true);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('zonesContainer').style.display = 'grid';
            });

            eventSource.addEventListener('zone-update', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    const zoneId = data.zone_id;
                    console.log(`Price update received for zone ${zoneId}:`, data);
                    updateZoneDisplay(zoneId, data);
                    updateCount++;
                    document.getElementById('totalUpdates').textContent = updateCount;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                } catch (error) {
                    console.error('Error processing zone update:', error);
                }
            });

            eventSource.onerror = function(event) {
                console.warn('SSE connection error for all zones');
                updateConnectionStatus(false);
                eventSource.close();
                
                // Retry after 3 seconds
                setTimeout(() => {
                    console.log('Reconnecting to all zones stream...');
                    connectAllZonesSSE();
                }, 3000);
            };

            sseConnections.set('all', eventSource);
        }

        function connectZoneSSE(zoneId) {
            // Close existing connection if any
            if (sseConnections.has(zoneId)) {
                const oldConnection = sseConnections.get(zoneId);
                oldConnection.close();
                sseConnections.delete(zoneId);
            }

            console.log(`Establishing SSE connection for zone ${zoneId}...`);
            const eventSource = new EventSource(`${API_BASE_URL}/zones/${zoneId}/stream`);
            
            eventSource.addEventListener('connected', function(event) {
                console.log(`âœ“ SSE connected for zone ${zoneId}`);
                reconnectAttempts.set(zoneId, 0); // Reset reconnect counter on success
                updateConnectionStatus(true);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('zonesContainer').style.display = 'grid';
            });

            eventSource.addEventListener('price-update', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log(`Price update received for zone ${zoneId}:`, data);
                    updateZoneDisplay(zoneId, data);
                    updateCount++;
                    document.getElementById('totalUpdates').textContent = updateCount;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                } catch (error) {
                    console.error(`Error processing SSE update for zone ${zoneId}:`, error);
                }
            });

            eventSource.onerror = function(event) {
                console.warn(`SSE connection error for zone ${zoneId}`);
                
                // Close the failed connection
                eventSource.close();
                sseConnections.delete(zoneId);
                
                // Get current reconnect attempts
                let attempts = reconnectAttempts.get(zoneId) || 0;
                
                if (attempts < MAX_RECONNECT_ATTEMPTS) {
                    attempts++;
                    reconnectAttempts.set(zoneId, attempts);
                    
                    // Exponential backoff: 2s, 4s, 8s, max 30s
                    const delay = Math.min(RECONNECT_DELAY * Math.pow(2, attempts - 1), 30000);
                    
                    console.log(`Reconnecting zone ${zoneId} in ${delay/1000}s (attempt ${attempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                    
                    setTimeout(() => {
                        connectZoneSSE(zoneId);
                    }, delay);
                } else {
                    console.error(`Max reconnection attempts reached for zone ${zoneId}`);
                    updateConnectionStatus(false);
                    document.getElementById('errorMessage').textContent = 
                        `Connection lost for zone ${zoneId}. Please refresh the page.`;
                    document.getElementById('errorMessage').style.display = 'block';
                }
            };

            sseConnections.set(zoneId, eventSource);
        }

        function disconnectSSE() {
            console.log('Disconnecting SSE streams...');
            sseConnections.forEach((eventSource, zoneId) => {
                eventSource.close();
            });
            sseConnections.clear();
        }

        // Reconnect all zones (useful for manual retry)
        function reconnectAllZones() {
            console.log('Reconnecting all zones...');
            disconnectSSE();
            setTimeout(() => {
                connectSSE();
            }, 500);
        }

        async function refreshAllZones() {
            try {
                const promises = [];
                for (let zoneId = 1; zoneId <= 16; zoneId++) {
                    promises.push(fetchZoneData(zoneId));
                }
                
                await Promise.all(promises);
                updateConnectionStatus(true);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('zonesContainer').style.display = 'grid';
                
                updateCount++;
                document.getElementById('totalUpdates').textContent = updateCount;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error refreshing zones:', error);
                updateConnectionStatus(false);
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        async function fetchZoneData(zoneId) {
            try {
                const response = await fetch(`${API_BASE_URL}/zones/${zoneId}/price`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                updateZoneDisplay(zoneId, data);
                
            } catch (error) {
                console.error(`Error fetching zone ${zoneId}:`, error);
                // Don't throw here to avoid breaking other zones
            }
        }

        function updateZoneDisplay(zoneId, data) {
            const previousData = previousZoneData[zoneId];
            previousZoneData[zoneId] = { ...data };
            
            // Update surge multiplier with animation
            const surgeElement = document.getElementById(`surge-${zoneId}`);
            // API returns surge_multiplier (snake_case)
            const currentSurge = parseFloat(data.surge_multiplier || data.surgeMultiplier || 1.0);
            const previousSurge = previousData ? parseFloat(previousData.surge_multiplier || previousData.surgeMultiplier || 1.0) : currentSurge;
            
            surgeElement.textContent = `${currentSurge.toFixed(1)}x`;
            
            // Determine change direction and apply animation
            if (currentSurge > previousSurge) {
                surgeElement.className = 'surge-multiplier increase';
            } else if (currentSurge < previousSurge) {
                surgeElement.className = 'surge-multiplier decrease';
            } else {
                surgeElement.className = 'surge-multiplier no-change';
            }
            
            // Update metrics
            document.getElementById(`demand-${zoneId}`).textContent = data.demand || 0;
            document.getElementById(`supply-${zoneId}`).textContent = data.supply || 0;
            
            // Update timestamp - force update every time
            const timestampElement = document.getElementById(`updated-${zoneId}`);
            if (timestampElement) {
                const now = new Date();
                timestampElement.textContent = `Updated: ${now.toLocaleTimeString()}`;
                console.log(`Zone ${zoneId} timestamp updated to ${now.toLocaleTimeString()}`);
            }
            
            // Store data for filtering
            zoneData[zoneId] = data;
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'status-indicator connected';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'status-indicator disconnected';
                textElement.textContent = 'Disconnected';
            }
        }

        function filterZones() {
            const showOnlySurge = document.getElementById('showOnlySurge').checked;
            const container = document.getElementById('zonesContainer');
            
            for (let zoneId = 1; zoneId <= 16; zoneId++) {
                const zoneCard = document.getElementById(`zone-${zoneId}`);
                const data = zoneData[zoneId];
                
                if (showOnlySurge && data) {
                    // API returns surge_multiplier (snake_case)
                    const surge = parseFloat(data.surge_multiplier || data.surgeMultiplier || 1.0);
                    zoneCard.style.display = surge > 1.0 ? 'block' : 'none';
                } else {
                    zoneCard.style.display = 'block';
                }
            }
        }

        async function loadExperimentStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/experiment/status`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                document.getElementById('experimentMode').textContent = 
                    data.deterministic === 'true' ? 'Deterministic âœ“' : 'Random';
                document.getElementById('experimentSeed').textContent = data.seed;
                document.getElementById('experimentScenario').textContent = data.scenario;
                
            } catch (error) {
                console.error('Error loading experiment status:', error);
                document.getElementById('experimentMode').textContent = 'Unknown';
            }
        }

        // SSE handles real-time updates - no polling needed!
    </script>
</body>
</html>
